/********************************************************************************************* */
//    Eduboard2 ESP32-S3 Template with BSP
//    Author: Martin Burger
//    Juventus Technikerschule
//    Version: 1.0.0
//    
//    This is the starting point for the QAM-Encoder Project. DAC-Streaming is setup and 
//    generates two sine signals on Channel DACA and DACB (GPIOX0 and GPIOX1)
//    The LCD is disabled as the DAC uses the same SPI Connection and DAC needs all the
//    SPI-Timeslots to remain synchronized.
/********************************************************************************************* */
#include "eduboard2.h"
#include "memon.h"

#include "math.h"

#define TAG "QAMEncoder"

#define UPDATETIME_MS 100

uint8_t sinedata[] = {0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,
                        0x7F,0x98,0xB0,0xC6,0xD9,0xE9,0xF4,0xFC,0xFE,0xFC,0xF4,0xE9,0xD9,0xC6,0xB0,0x98,
                        0x7F,0x66,0x4E,0x38,0x25,0x15,0xA,0x2,0x0,0x2,0xA,0x15,0x25,0x38,0x4E,0x66,};

void dacCallbackFunction() {
    dac_load_stream_data(sinedata, sinedata);
}

void dacTask(void* param) {
    //Init stuff here
    dac_set_config(DAC_A, DAC_GAIN_1, true);
    dac_set_config(DAC_B, DAC_GAIN_1, true);
    dac_update();
    dac_set_stream_callback(&dacCallbackFunction);
    dac_load_stream_data(sinedata, sinedata);
    vTaskDelay(100);
    for(;;) {
        vTaskDelay(UPDATETIME_MS/portTICK_PERIOD_MS);
    }
}

void app_main()
{
    //Initialize Eduboard2 BSP
    eduboard2_init();
    xTaskCreate(dacTask,"dacTask",2*2048,NULL,10,NULL);
    for(;;) {
        vTaskDelay(2000/portTICK_PERIOD_MS);
        ESP_LOGI(TAG, "QAM Encoder");
    }
}