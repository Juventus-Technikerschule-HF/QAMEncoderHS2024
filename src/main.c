/********************************************************************************************* */
//    Eduboard2 ESP32-S3 Template with BSP
//    Author: Martin Burger
//    Juventus Technikerschule
//    Version: 1.0.0
//    
//    This is the starting point for the QAM-Encoder Project. DAC-Streaming is setup and 
//    generates two sine signals on Channel DACA and DACB (GPIOX0 and GPIOX1)
//    The LCD is disabled as the DAC uses the same SPI Connection and DAC needs all the
//    SPI-Timeslots to remain synchronized.
/********************************************************************************************* */
#include "eduboard2.h"
#include "memon.h"

#include "math.h"

#define TAG "QAMEncoder"

#define UPDATETIME_MS 100

uint8_t sinedata[] = {0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0xf,0x16,0x1f,0x28,
                      0x32,0x3c,0x45,0x4e,0x55,0x5c,0x60,0x63,0x64,0x63,0x60,0x5c,0x55,0x4e,0x45,
                      0x3c,0x32,0x28,0x1f,0x16,0xf,0x8,0x4,0x1,0x0,0x1,0x4,0x8,0x80,0x00,0x80,0x00};

void dacCallbackFunction() {
    dac_load_stream_data(sinedata, sinedata);
}

void dacTask(void* param) {
    //Init stuff here
    dac_set_config(DAC_A, DAC_GAIN_1, true);
    dac_set_config(DAC_B, DAC_GAIN_1, true);
    dac_update();
    dac_set_stream_callback(&dacCallbackFunction);
    dac_load_stream_data(sinedata, sinedata);
    vTaskDelay(100);
    for(;;) {
        vTaskDelay(UPDATETIME_MS/portTICK_PERIOD_MS);
    }
}

void app_main()
{
    //Initialize Eduboard2 BSP
    eduboard2_init();
    xTaskCreate(dacTask,"dacTask",2*2048,NULL,10,NULL);
    for(;;) {
        vTaskDelay(2000/portTICK_PERIOD_MS);
        ESP_LOGI(TAG, "QAM Encoder");
    }
}